<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPA & CGPA Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #0f172a 50%, #1e1b4b 75%, #0f172a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .table-container {
            overflow-x: auto;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Optimized grade styling */
        .grade-a-plus { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: #ffffff; 
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }
        .grade-a { 
            background: linear-gradient(135deg, #34d399, #10b981); 
            color: #ffffff; 
            box-shadow: 0 0 6px rgba(52, 211, 153, 0.3);
        }
        .grade-b { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: #ffffff; 
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.3);
        }
        .grade-c { 
            background: linear-gradient(135deg, #fb923c, #ea580c); 
            color: #ffffff; 
            box-shadow: 0 0 6px rgba(251, 146, 60, 0.3);
        }
        .grade-d { 
            background: linear-gradient(135deg, #f87171, #ef4444); 
            color: #ffffff; 
            box-shadow: 0 0 6px rgba(248, 113, 113, 0.3);
        }
        .grade-e { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: #ffffff; 
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
        }
        .grade-f { 
            background: linear-gradient(135deg, #6b7280, #4b5563); 
            color: #ffffff; 
            box-shadow: 0 0 4px rgba(107, 114, 128, 0.2);
        }

        /* Custom input styling */
        .dark-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
            transition: all 0.2s ease;
        }
        .dark-input:focus {
            background-color: #4b5563;
            border-color: #6366f1;
            ring: 0;
            outline: 0;
        }
        .editable-input {
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            transition: all 0.2s ease;
        }
        .editable-input:focus {
            outline: none;
            background-color: #1f2937;
            border-color: #4f46e5;
        }
        
        /* Modal optimizations */
        .modal-overlay {
            transition: opacity 0.15s ease-in-out;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            transition: transform 0.15s ease-in-out;
        }
        
        /* Optimized scrollbar */
        .table-container::-webkit-scrollbar {
            height: 6px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }

        .chart-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Performance optimizations */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hover-scale {
            transition: transform 0.2s ease;
        }
        .hover-scale:hover {
            transform: scale(1.02);
        }

        /* Reduced motion for better performance */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-full mx-auto bg-gray-900/30 backdrop-blur-xl border border-gray-600/30 p-8 rounded-3xl shadow-2xl shadow-black/40 relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 via-purple-500/5 to-pink-500/5 rounded-3xl"></div>
        <div class="relative z-10">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold bg-gradient-to-r from-white via-blue-100 to-purple-200 bg-clip-text text-transparent drop-shadow-2xl">Academic Dashboard</h1>
                <p class="text-slate-300 mt-2 text-lg font-medium">GPA & CGPA Toolkit</p>
                 <div class="mt-6 flex flex-wrap gap-3">
                     <button id="view-grading-btn" class="px-4 py-2 bg-gradient-to-r from-indigo-500/20 to-purple-500/20 backdrop-blur-sm border border-indigo-400/30 rounded-lg text-sm text-indigo-300 hover:text-white hover:bg-gradient-to-r hover:from-indigo-500/40 hover:to-purple-500/40 font-semibold transition-all duration-200 hover-scale">View/Edit Grading System</button>
                     <button id="view-trends-btn" class="px-4 py-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 backdrop-blur-sm border border-purple-400/30 rounded-lg text-sm text-purple-300 hover:text-white hover:bg-gradient-to-r hover:from-purple-500/40 hover:to-pink-500/40 font-semibold transition-all duration-200 hover-scale">View Trends</button>
                 </div>
            </div>
            <div class="mt-6 md:mt-0 w-full md:w-auto text-center md:text-right space-y-4">
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                     <div class="relative bg-gradient-to-br from-slate-800/40 via-slate-700/40 to-slate-800/40 backdrop-blur-lg p-6 rounded-2xl border border-slate-600/30 shadow-xl group hover:shadow-2xl transition-all duration-200 hover-scale">
                         <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-cyan-500/10 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                         <div class="relative">
                             <h2 class="text-sm font-bold text-slate-300 tracking-wide uppercase">Predicted SGPA</h2>
                             <p id="sgpa-display" class="text-4xl sm:text-5xl font-black bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent mt-2">0.00</p>
                         </div>
                     </div>
                      <div class="relative bg-gradient-to-br from-slate-800/40 via-indigo-900/40 to-purple-900/40 backdrop-blur-lg p-6 rounded-2xl border border-indigo-500/30 shadow-xl group hover:shadow-2xl transition-all duration-200 hover-scale">
                         <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                         <div class="relative">
                             <h2 class="text-sm font-bold text-indigo-200 tracking-wide uppercase mb-4">Overall CGPA</h2>
                             <p id="cgpa-display" class="text-4xl sm:text-5xl font-black bg-gradient-to-r from-indigo-200 via-purple-200 to-pink-200 bg-clip-text text-transparent mb-4">0.00</p>
                             <div class="flex items-center justify-center space-x-3 bg-indigo-900/20 rounded-xl p-3 border border-indigo-400/20">
                                 <label for="target-sgpa" class="text-sm font-bold text-indigo-300 whitespace-nowrap">Target SGPA:</label>
                                 <input type="number" id="target-sgpa" class="w-20 rounded-lg bg-indigo-900/40 border border-indigo-400/40 text-indigo-100 shadow-lg text-sm backdrop-blur-sm focus:ring-2 focus:ring-indigo-400 focus:border-transparent focus:bg-indigo-800/60 transition-all font-semibold text-center" step="0.1" min="0" max="10" placeholder="8.5">
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="flex justify-end mt-2">
                     <button id="view-sgpa-info-btn" class="text-xs text-gray-500 hover:text-gray-300 font-semibold transition-colors">What's this?</button>
                 </div>
                 <div id="goal-message" class="text-sm text-gray-400 font-medium min-h-[2.5rem] mt-2 text-center sm:text-right"></div>
            </div>
        </div>

        <div class="border-b border-gray-700 mb-4">
            <nav id="semester-tabs" class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                </nav>
        </div>

        <div class="table-container border border-slate-600/30 rounded-xl bg-slate-900/20 backdrop-blur-sm shadow-2xl">
            <table class="w-full text-sm text-left text-slate-200 min-w-[1200px]">
                <thead id="table-header" class="text-xs text-slate-300 uppercase bg-gradient-to-r from-slate-800/80 to-slate-700/80 backdrop-blur-sm">
                    <tr>
                        <th scope="col" class="px-4 py-3 w-48">Course</th>
                        <th scope="col" class="px-4 py-3 text-center">Credits</th>
                        <th scope="col" class="px-4 py-3">Quiz 1</th>
                        <th scope="col" class="px-4 py-3">Quiz 2</th>
                        <th scope="col" class="px-4 py-3">Mid Sem</th>
                        <th scope="col" class="px-4 py-3">End Sem</th>
                        <th scope="col" class="px-4 py-3">Prof. Marks</th>
                        <th scope="col" class="px-4 py-3 text-center">Total</th>
                        <th scope="col" class="px-4 py-3 text-center">Grade</th>
                        <th scope="col" class="px-4 py-3 text-center">Goal</th>
                        <th scope="col" class="px-4 py-3 text-center">Attendance</th>
                        <th scope="col" class="px-4 py-3 text-center">Bunks Left</th>
                        <th scope="col" class="px-4 py-3 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="courses-tbody" class="divide-y divide-gray-800">
                    </tbody>
            </table>
        </div>
        <div class="mt-6 flex justify-end">
            <button id="add-course-btn" class="flex items-center space-x-3 px-6 py-3 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 text-white font-bold rounded-xl shadow-xl hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-indigo-400/50 transition-all duration-200 hover-scale relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                <div class="relative z-10 flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    <span>Add New Course</span>
                </div>
            </button>
        </div>
    </div>
    </div>

    <div id="grading-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-overlay">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col modal-content">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">Grading System</h3>
                <button data-close-modal="grading-modal" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                        <tr>
                            <th class="px-4 py-2">Min. Marks (%)</th>
                            <th class="px-4 py-2">Grade</th>
                            <th class="px-4 py-2">Grade Point</th>
                        </tr>
                    </thead>
                    <tbody id="grading-system-body" class="divide-y divide-gray-700">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="trends-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-overlay">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">SGPA Trends</h3>
                <button data-close-modal="trends-modal" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="trends-chart-container"></div>
            </div>
        </div>
    </div>

    <div id="sgpa-info-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-overlay">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col modal-content">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">SGPA Metrics Explained</h3>
                <button data-close-modal="sgpa-info-modal" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <div>
                    <h4 class="font-bold text-white">Predicted SGPA</h4>
                    <p class="text-sm text-gray-400">An estimate of your final SGPA for the current semester. For courses where you've entered some marks, it projects your final score based on your current average performance in that subject. This shows where you're headed if you maintain your current performance. Courses with no marks entered are not included in this prediction.</p>
                </div>
                <div>
                    <h4 class="font-bold text-white">Overall CGPA</h4>
                    <p class="text-sm text-gray-400">Your Cumulative Grade Point Average, calculated across all semesters you have entered. It's based on the final grade for every course.</p>
                </div>
                <div>
                    <h4 class="font-bold text-white">Target SGPA & Goal Column</h4>
                    <p class="text-sm text-gray-400">When you set a Target SGPA, the 'Goal' column calculates the total marks you need to score in the remaining, empty assessments for each course to achieve your overall target. It helps you create a clear study plan.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-overlay">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-sm flex flex-col modal-content">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-white">Confirm Deletion</h3>
                <p id="confirm-modal-text" class="text-sm text-gray-400 mt-2"></p>
            </div>
            <div class="flex justify-end gap-4 bg-gray-700/50 p-4">
                <button id="cancel-delete-btn" class="px-4 py-2 text-sm font-medium rounded-md hover:bg-gray-600">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-red-600 hover:bg-red-700 text-white">Delete</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements and State ---
            const tbody = document.getElementById('courses-tbody');
            const sgpaDisplay = document.getElementById('sgpa-display');
            const cgpaDisplay = document.getElementById('cgpa-display');
            const targetSgpaInput = document.getElementById('target-sgpa');
            const addCourseBtn = document.getElementById('add-course-btn');
            const goalMessage = document.getElementById('goal-message');
            const semesterTabs = document.getElementById('semester-tabs');
            
            let allSemesters = [];
            let activeSemesterIndex = 0;
            let appState = {
                targetSgpa: 0,
                gradingSystem: [
                    { marks: 90, letter: 'A+', point: 10, class: 'grade-a-plus' },
                    { marks: 80, letter: 'A', point: 9, class: 'grade-a' },
                    { marks: 70, letter: 'B', point: 8, class: 'grade-b' },
                    { marks: 60, letter: 'C', point: 7, class: 'grade-c' },
                    { marks: 50, letter: 'D', point: 6, class: 'grade-d' },
                    { marks: 40, letter: 'E', point: 5, class: 'grade-e' },
                    { marks: 0, letter: 'F', point: 0, class: 'grade-f' }
                ]
            };

            const MIN_ATTENDANCE_REQ = 0.75;

            // Performance optimization: Debounce calculations
            let calculateTimeout;
            function debouncedCalculate() {
                clearTimeout(calculateTimeout);
                calculateTimeout = setTimeout(updateCalculations, 50);
            }

            // --- Data Persistence ---
            function saveData() {
                try {
                    localStorage.setItem('allSemesters', JSON.stringify(allSemesters));
                    localStorage.setItem('activeSemesterIndex', activeSemesterIndex);
                    localStorage.setItem('gradeCalculatorTargetSgpa', appState.targetSgpa);
                    localStorage.setItem('gradeCalculatorGradingSystem', JSON.stringify(appState.gradingSystem));
                } catch (e) {
                    console.warn('Failed to save data to localStorage:', e);
                }
            }

            function loadData() {
                try {
                    const savedSemesters = localStorage.getItem('allSemesters');
                    const savedActiveIndex = localStorage.getItem('activeSemesterIndex');
                    const savedTargetSgpa = localStorage.getItem('gradeCalculatorTargetSgpa');
                    const savedGradingSystem = localStorage.getItem('gradeCalculatorGradingSystem');

                    if (savedSemesters) {
                        allSemesters = JSON.parse(savedSemesters);
                        // Data migration for older versions
                        allSemesters.forEach(sem => {
                            sem.courses.forEach(course => {
                                if (!course.maxMarks) course.maxMarks = { q1: 10, q2: 10, mid: 25, end: 50, prof: 5 };
                                if (course.isEditingMarks === undefined) course.isEditingMarks = false;
                                if (!course.attendance) course.attendance = { attended: 0, total: 0 };
                            });
                        });
                    } else {
                        allSemesters = [];
                    }
                    if (savedActiveIndex) activeSemesterIndex = parseInt(savedActiveIndex, 10);
                    if (savedTargetSgpa) appState.targetSgpa = parseFloat(savedTargetSgpa) || 0;
                    if (savedGradingSystem) appState.gradingSystem = JSON.parse(savedGradingSystem);
                    
                    if (activeSemesterIndex >= allSemesters.length) activeSemesterIndex = 0;
                } catch (e) {
                    console.warn('Failed to load data from localStorage:', e);
                    allSemesters = [];
                    activeSemesterIndex = 0;
                }
            }

            // --- Calculation Logic (Optimized) ---
            const gradeCache = new Map();
            
            function getGrade(marks, courseMaxMarks) {
                const totalMaxMarks = Object.values(courseMaxMarks).reduce((sum, mark) => sum + mark, 0);
                if (totalMaxMarks === 0) return { letter: 'N/A', point: 0, class: 'grade-f' };
                
                const percentage = (marks / totalMaxMarks) * 100;
                const cacheKey = `${percentage.toFixed(2)}`;
                
                if (gradeCache.has(cacheKey)) {
                    return gradeCache.get(cacheKey);
                }
                
                let grade = appState.gradingSystem[appState.gradingSystem.length - 1];
                for (const g of appState.gradingSystem) {
                    if (percentage >= g.marks) {
                        grade = g;
                        break;
                    }
                }
                
                gradeCache.set(cacheKey, grade);
                return grade;
            }
            
            function calculateSemesterSGPA(semester) {
                let totalCredits = 0;
                let weightedPoints = 0;
                semester.courses.forEach(course => {
                    const credits = course.credits || 0;
                    if (credits > 0) {
                        totalCredits += credits;
                        const totalMarks = Object.values(course.marks).reduce((sum, mark) => sum + (parseFloat(mark) || 0), 0);
                        weightedPoints += getGrade(totalMarks, course.maxMarks).point * credits;
                    }
                });
                return totalCredits > 0 ? weightedPoints / totalCredits : 0;
            }
            
            function gradePointToMarks(requiredPoint, courseMaxMarks) {
                const totalMax = Object.values(courseMaxMarks).reduce((s, v) => s + v, 0);
                for (let i = appState.gradingSystem.length - 1; i >= 0; i--) {
                    const grade = appState.gradingSystem[i];
                    if (requiredPoint <= grade.point) {
                        return (grade.marks / 100) * totalMax;
                    }
                }
                return totalMax + 1;
            }

            // --- Optimized DOM Update Logic ---
            let renderTimeout;
            function fullRender() {
                clearTimeout(renderTimeout);
                renderTimeout = setTimeout(() => {
                    renderSemesterTabs();
                    renderCourseTable();
                    updateCalculations();
                }, 10);
            }

            function renderCourseTable() {
                const fragment = document.createDocumentFragment();
                const activeSemester = allSemesters[activeSemesterIndex];
                
                if (!activeSemester) {
                    tbody.innerHTML = `<tr><td colspan="13" class="text-center py-8 text-gray-500">No semesters found. Add a course to get started!</td></tr>`;
                    return;
                }
                
                if (activeSemester.courses.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="13" class="text-center py-8 text-gray-500">This semester is empty. Add a new course.</td></tr>`;
                } else {
                    activeSemester.courses.forEach((course, index) => {
                        const row = document.createElement('tr');
                        row.className = 'bg-slate-900/30 hover:bg-slate-800/60 transition-all duration-150 hover:shadow-lg border-b border-slate-700/50 fade-in';
                        row.id = `course-${index}`;
                        row.innerHTML = `
                            <td class="px-2 py-3">
                                <input type="text" data-field="code" data-index="${index}" class="editable-input w-full font-semibold text-white" value="${course.code}">
                                <input type="text" data-field="title" data-index="${index}" class="editable-input w-full text-xs text-gray-400" value="${course.title}">
                            </td>
                            <td class="px-2 py-3 text-center"><input type="number" data-field="credits" data-index="${index}" class="editable-input w-20 text-center font-medium" value="${course.credits}" step="0.5"></td>
                            <td class="px-4 py-3"><input type="number" data-type="q1" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" min="0" max="${course.maxMarks.q1}" value="${course.marks.q1 || ''}"></td>
                            <td class="px-4 py-3"><input type="number" data-type="q2" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" min="0" max="${course.maxMarks.q2}" value="${course.marks.q2 || ''}"></td>
                            <td class="px-4 py-3"><input type="number" data-type="mid" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" min="0" max="${course.maxMarks.mid}" value="${course.marks.mid || ''}"></td>
                            <td class="px-4 py-3"><input type="number" data-type="end" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" min="0" max="${course.maxMarks.end}" value="${course.marks.end || ''}"></td>
                            <td class="px-4 py-3"><input type="number" data-type="prof" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" min="0" max="${course.maxMarks.prof}" value="${course.marks.prof || ''}"></td>
                            <td data-field="total" class="px-4 py-3 text-center font-bold text-white"></td>
                            <td class="px-4 py-3 text-center font-bold"><span data-field="grade"></span></td>
                            <td data-field="goal" class="px-4 py-3 text-center font-semibold text-indigo-300"></td>
                            <td class="px-4 py-3 text-center">
                                 <div class="flex items-center justify-center space-x-2">
                                     <button data-action="attend-class" data-index="${index}" class="px-2 py-1 bg-green-500/20 text-green-300 text-xs rounded-md hover:bg-green-500/40 font-semibold transition-colors"><span class="hidden sm:inline">+ Attended</span><span class="sm:hidden">+</span></button>
                                     <span data-field="attendance-tracker" class="font-mono text-sm w-12 text-center"></span>
                                     <button data-action="miss-class" data-index="${index}" class="px-2 py-1 bg-red-500/20 text-red-300 text-xs rounded-md hover:bg-red-500/40 font-semibold transition-colors"><span class="hidden sm:inline">– Missed</span><span class="sm:hidden">–</span></button>
                                 </div>
                            </td>
                            <td data-field="bunks" class="px-4 py-3 text-center font-bold"></td>
                            <td class="px-4 py-3 text-center">
                                 <div class="flex items-center justify-center space-x-2">
                                     <button data-action="settings" data-index="${index}" class="text-gray-400 hover:text-white transition-colors" title="Edit Mark Distribution">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                                     </button>
                                     <button data-action="remove" data-index="${index}" class="text-gray-400 hover:text-red-500 transition-colors" title="Remove Course">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                     </button>
                                 </div>
                            </td>
                        `;
                        fragment.appendChild(row);

                        if (course.isEditingMarks) {
                            const settingsRow = document.createElement('tr');
                            settingsRow.className = 'bg-gray-800/50 fade-in';
                            const totalMax = Object.values(course.maxMarks).reduce((s, v) => s + v, 0);
                            settingsRow.innerHTML = `
                                <td class="px-2 py-2 text-xs text-gray-400 font-semibold" colspan="2">Max Marks:</td>
                                <td class="px-4 py-2"><input type="number" data-max-type="q1" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${course.maxMarks.q1}"></td>
                                <td class="px-4 py-2"><input type="number" data-max-type="q2" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${course.maxMarks.q2}"></td>
                                <td class="px-4 py-2"><input type="number" data-max-type="mid" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${course.maxMarks.mid}"></td>
                                <td class="px-4 py-2"><input type="number" data-max-type="end" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${course.maxMarks.end}"></td>
                                <td class="px-4 py-2"><input type="number" data-max-type="prof" data-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${course.maxMarks.prof}"></td>
                                <td class="px-4 py-2 text-center font-bold text-white">${totalMax}</td>
                                <td colspan="5"></td>
                            `;
                            fragment.appendChild(settingsRow);
                        }
                    });
                }
                
                tbody.innerHTML = '';
                tbody.appendChild(fragment);
            }
            
            function renderSemesterTabs() {
                const fragment = document.createDocumentFragment();
                
                allSemesters.forEach((sem, index) => {
                    const tabContainer = document.createElement('div');
                    tabContainer.className = 'relative flex items-center';
                    
                    const tab = document.createElement('button');
                    tab.dataset.index = index;
                    tab.textContent = sem.name;
                    const activeClasses = 'border-indigo-500 text-indigo-400';
                    const inactiveClasses = 'border-transparent text-gray-500 hover:text-gray-300 hover:border-gray-300';
                    tab.className = `whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors ${index === activeSemesterIndex ? activeClasses : inactiveClasses}`;
                    tab.addEventListener('click', () => {
                        activeSemesterIndex = index;
                        fullRender();
                    });
                    
                    if (allSemesters.length > 1) {
                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = '×';
                        removeBtn.className = 'ml-2 text-gray-500 hover:text-red-400 text-lg font-bold transition-colors';
                        removeBtn.title = `Remove ${sem.name}`;
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const modal = document.getElementById('confirm-modal');
                            document.getElementById('confirm-modal-text').textContent = `Are you sure you want to remove "${sem.name}"? All courses in this semester will be deleted. This action cannot be undone.`;
                            modal.classList.remove('hidden');
                            modal.dataset.semesterIndex = index;
                        });
                        tabContainer.appendChild(tab);
                        tabContainer.appendChild(removeBtn);
                    } else {
                        tabContainer.appendChild(tab);
                    }
                    
                    fragment.appendChild(tabContainer);
                });
                
                const addSemTab = document.createElement('button');
                addSemTab.id = 'add-semester-btn';
                addSemTab.innerHTML = '&#43; Add Sem';
                addSemTab.className = 'whitespace-nowrap py-3 px-2 font-medium text-sm text-gray-500 hover:text-indigo-400 transition-colors';
                addSemTab.addEventListener('click', () => {
                    const newSemName = `Semester ${allSemesters.length + 1}`;
                    allSemesters.push({ name: newSemName, courses: [] });
                    activeSemesterIndex = allSemesters.length - 1;
                    fullRender();
                });
                fragment.appendChild(addSemTab);
                
                semesterTabs.innerHTML = '';
                semesterTabs.appendChild(fragment);
            }
            
            function updateCalculations() {
                const activeSemester = allSemesters[activeSemesterIndex];
                if (!activeSemester) {
                    sgpaDisplay.textContent = '0.00';
                    cgpaDisplay.textContent = '0.00';
                    return;
                }

                let totalCredits = 0;
                let currentWeightedPoints = 0;
                let predictedWeightedPoints = 0;
                let completedCoursesCredits = 0;
                let completedCoursesPoints = 0;
                let predictedCoursesCredits = 0;

                activeSemester.courses.forEach(course => {
                    const credits = course.credits || 0;
                    if (credits > 0) totalCredits += credits;
                    const totalMaxMarks = Object.values(course.maxMarks).reduce((s, v) => s + v, 0);

                    let courseSecuredMarks = 0;
                    let courseMaxSecuredMarks = 0;
                    let isComplete = true;
                    
                    Object.keys(course.maxMarks).forEach(key => {
                        const mark = parseFloat(course.marks[key]);
                        if (!isNaN(mark) && course.marks[key] !== '' && course.marks[key] !== null) {
                            courseSecuredMarks += mark;
                            courseMaxSecuredMarks += course.maxMarks[key];
                        } else {
                            isComplete = false;
                        }
                    });

                    if(isComplete && credits > 0) {
                        completedCoursesCredits += credits;
                        completedCoursesPoints += getGrade(courseSecuredMarks, course.maxMarks).point * credits;
                    }
                    
                    if (courseMaxSecuredMarks > 0 && credits > 0) {
                        predictedCoursesCredits += credits;
                        const currentAvgPercent = courseSecuredMarks / courseMaxSecuredMarks;
                        const predictedTotalMarks = currentAvgPercent * totalMaxMarks;
                        predictedWeightedPoints += getGrade(predictedTotalMarks, course.maxMarks).point * credits;
                    }
                });

                const predictedSgpa = predictedCoursesCredits > 0 ? predictedWeightedPoints / predictedCoursesCredits : 0;
                sgpaDisplay.textContent = predictedSgpa.toFixed(2);
                
                // CGPA Calculation
                let totalCgpaCredits = 0;
                let totalCgpaPoints = 0;
                allSemesters.forEach(sem => {
                    let semCredits = 0;
                    let semPoints = 0;
                    sem.courses.forEach(c => {
                        const credits = c.credits || 0;
                        if(credits > 0) {
                            semCredits += credits;
                            const totalMarks = Object.values(c.marks).reduce((s, m) => s + (parseFloat(m) || 0), 0);
                            semPoints += getGrade(totalMarks, c.maxMarks).point * credits;
                        }
                    });
                    if(semCredits > 0) {
                        totalCgpaCredits += semCredits;
                        totalCgpaPoints += semPoints;
                    }
                });
                const cgpa = totalCgpaCredits > 0 ? totalCgpaPoints / totalCgpaCredits : 0;
                cgpaDisplay.textContent = cgpa.toFixed(2);

                const targetSgpa = appState.targetSgpa;
                let requiredAvgPoint = -1;
                if(targetSgpa > 0 && totalCredits > 0) {
                    const requiredTotalPoints = targetSgpa * totalCredits;
                    const remainingPointsNeeded = requiredTotalPoints - completedCoursesPoints;
                    const remainingCredits = totalCredits - completedCoursesCredits;
                    if (remainingCredits > 0) {
                        requiredAvgPoint = remainingPointsNeeded / remainingCredits;
                    } else if (remainingPointsNeeded > 0) {
                        requiredAvgPoint = 11;
                    } else {
                        requiredAvgPoint = 0;
                    }
                    goalMessage.innerHTML = `To get <span class="font-bold text-white">${targetSgpa.toFixed(2)} SGPA</span>, you need an average of <span class="font-bold text-white">${requiredAvgPoint.toFixed(2)}</span> grade points in remaining subjects.`;
                } else {
                    goalMessage.innerHTML = 'Set a Target SGPA to see what you need to score.';
                }

                // Optimized course row updates
                activeSemester.courses.forEach((course, index) => {
                    const row = document.getElementById(`course-${index}`);
                    if (!row) return;

                    const totalMaxMarks = Object.values(course.maxMarks).reduce((s, v) => s + v, 0);
                    const currentTotalMarks = Object.values(course.marks).reduce((sum, mark) => sum + (parseFloat(mark) || 0), 0);
                    const gradeInfo = getGrade(currentTotalMarks, course.maxMarks);
                    
                    const totalCell = row.querySelector('[data-field="total"]');
                    const gradeSpan = row.querySelector('[data-field="grade"]');
                    const attendanceCell = row.querySelector('[data-field="attendance-tracker"]');
                    const bunksLeftCell = row.querySelector('[data-field="bunks"]');
                    const goalCell = row.querySelector('[data-field="goal"]');
                    
                    if (totalCell) totalCell.textContent = `${currentTotalMarks.toFixed(1)} / ${totalMaxMarks}`;
                    if (gradeSpan) {
                        gradeSpan.textContent = gradeInfo.letter;
                        gradeSpan.className = `px-3 py-1 rounded-full text-xs font-bold ${gradeInfo.class}`;
                    }
                    
                    const attended = course.attendance.attended || 0;
                    const totalClasses = course.attendance.total || 0;
                    if (attendanceCell) attendanceCell.textContent = `${attended}/${totalClasses}`;
                    
                    if (bunksLeftCell) {
                        if (totalClasses > 0) {
                            const bunksLeft = Math.floor(totalClasses * (1 - MIN_ATTENDANCE_REQ)) - (totalClasses - attended);
                            bunksLeftCell.textContent = bunksLeft;
                            bunksLeftCell.className = `px-4 py-3 text-center font-bold ${bunksLeft < 0 ? 'text-red-400' : bunksLeft <= 2 ? 'text-yellow-400' : 'text-green-400'}`;
                        } else {
                            bunksLeftCell.textContent = 'N/A';
                            bunksLeftCell.className = 'px-4 py-3 text-center font-bold text-gray-400';
                        }
                    }

                    if (goalCell) {
                        let isCourseComplete = Object.values(course.marks).every(m => m !== '' && m !== null);
                        
                        if(targetSgpa > 0 && !isCourseComplete && requiredAvgPoint !== -1) {
                             if (requiredAvgPoint > 10) {
                                 goalCell.innerHTML = `<span class="text-red-400">Impossible</span>`;
                             } else if (requiredAvgPoint <= 0) {
                                 goalCell.innerHTML = `<span class="text-green-400">Secured</span>`;
                             }
                             else {
                                const requiredMarks = gradePointToMarks(requiredAvgPoint, course.maxMarks);
                                const securedMarks = currentTotalMarks;
                                const needed = requiredMarks - securedMarks;
                                
                                let remainingMax = 0;
                                Object.keys(course.marks).forEach(k => {
                                    if(course.marks[k] === '' || course.marks[k] === null) remainingMax += course.maxMarks[k];
                                });

                                if (needed > remainingMax) {
                                    goalCell.innerHTML = `<span class="text-red-400" title="Needed / Remaining Max">${needed.toFixed(1)}/${remainingMax}</span>`;
                                } else {
                                    goalCell.innerHTML = `<span title="Needed / Remaining Max">${Math.max(0, needed).toFixed(1)}/${remainingMax}</span>`;
                                }
                             }
                        } else {
                            goalCell.textContent = isCourseComplete ? 'Done' : '–';
                        }
                    }
                });
                
                saveData();
            }
            
            // --- Optimized Event Listeners ---
            addCourseBtn.addEventListener('click', () => {
                if (allSemesters.length === 0) {
                    allSemesters.push({ name: 'Semester 1', courses: [] });
                    activeSemesterIndex = 0;
                }
                allSemesters[activeSemesterIndex].courses.push({ 
                    code: 'NEW', 
                    title: 'New Course', 
                    credits: 3, 
                    marks: { q1: '', q2: '', mid: '', end: '', prof: '' }, 
                    attendance: { attended: 0, total: 0 },
                    maxMarks: { q1: 10, q2: 10, mid: 25, end: 50, prof: 5 },
                    isEditingMarks: false
                });
                fullRender();
            });

            tbody.addEventListener('input', (e) => {
                const target = e.target;
                const index = parseInt(target.dataset.index, 10);
                if (isNaN(index) || !allSemesters[activeSemesterIndex]?.courses[index]) return;

                const field = target.dataset.field;
                const type = target.dataset.type;
                const maxType = target.dataset.maxType;
                const course = allSemesters[activeSemesterIndex].courses[index];

                if (field) {
                    course[field] = (field === 'credits') ? parseFloat(target.value) || 0 : target.value;
                } else if (type) {
                    const value = parseFloat(target.value);
                    if (isNaN(value)) {
                        course.marks[type] = '';
                    } else {
                        const max = parseFloat(course.maxMarks[type]);
                        target.value = Math.min(Math.max(0, value), max);
                        course.marks[type] = target.value;
                    }
                } else if (maxType) {
                    course.maxMarks[maxType] = parseFloat(target.value) || 0;
                    gradeCache.clear(); // Clear cache when max marks change
                    fullRender();
                    return;
                }
                debouncedCalculate();
            });
            
            tbody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const action = target.dataset.action;
                const index = parseInt(target.dataset.index, 10);
                if (isNaN(index) || !allSemesters[activeSemesterIndex]?.courses[index]) return;
                
                const course = allSemesters[activeSemesterIndex].courses[index];
                if (action === 'remove') {
                    const modal = document.getElementById('confirm-modal');
                    document.getElementById('confirm-modal-text').textContent = `Are you sure you want to remove ${course.code}? This action cannot be undone.`
                    modal.classList.remove('hidden');
                    modal.dataset.courseIndex = index;
                } else if (action === 'attend-class') {
                    course.attendance.attended++;
                    course.attendance.total++;
                } else if (action === 'miss-class') {
                    course.attendance.total++;
                } else if (action === 'settings') {
                    course.isEditingMarks = !course.isEditingMarks;
                }
                fullRender();
            });
            
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                const modal = document.getElementById('confirm-modal');
                const courseIndex = parseInt(modal.dataset.courseIndex, 10);
                const semesterIndex = parseInt(modal.dataset.semesterIndex, 10);
                
                if (!isNaN(courseIndex) && allSemesters[activeSemesterIndex]) {
                    allSemesters[activeSemesterIndex].courses.splice(courseIndex, 1);
                    fullRender();
                } else if (!isNaN(semesterIndex) && allSemesters[semesterIndex]) {
                    allSemesters.splice(semesterIndex, 1);
                    if (activeSemesterIndex >= allSemesters.length) {
                        activeSemesterIndex = Math.max(0, allSemesters.length - 1);
                    } else if (activeSemesterIndex > semesterIndex) {
                        activeSemesterIndex--;
                    }
                    if (allSemesters.length === 0) {
                        allSemesters.push({ name: 'Semester 1', courses: [] });
                        activeSemesterIndex = 0;
                    }
                    fullRender();
                }
                modal.classList.add('hidden');
            });

            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                document.getElementById('confirm-modal').classList.add('hidden');
            });

            targetSgpaInput.addEventListener('input', (e) => {
                appState.targetSgpa = parseFloat(e.target.value) || 0;
                debouncedCalculate();
            });
            
            document.querySelectorAll('[data-close-modal]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById(btn.dataset.closeModal).classList.add('hidden');
                });
            });
            
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });

            document.getElementById('view-grading-btn').addEventListener('click', () => {
                const gradingBody = document.getElementById('grading-system-body');
                gradingBody.innerHTML = '';
                appState.gradingSystem.forEach((grade, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3"><input type="number" data-grade-field="marks" data-grade-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${grade.marks}"></td>
                        <td class="px-4 py-3"><input type="text" data-grade-field="letter" data-grade-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${grade.letter}"></td>
                        <td class="px-4 py-3"><input type="number" data-grade-field="point" data-grade-index="${index}" class="w-20 rounded-md dark-input shadow-sm" value="${grade.point}" step="0.5"></td>
                    `;
                    gradingBody.appendChild(row);
                });
                document.getElementById('grading-modal').classList.remove('hidden');
            });
            
            document.getElementById('grading-system-body').addEventListener('input', (e) => {
                const target = e.target;
                const index = parseInt(target.dataset.gradeIndex, 10);
                const field = target.dataset.gradeField;
                if (!isNaN(index) && field) {
                    const value = (field === 'letter') ? target.value : parseFloat(target.value) || 0;
                    appState.gradingSystem[index][field] = value;
                    appState.gradingSystem.sort((a, b) => b.marks - a.marks);
                    gradeCache.clear(); // Clear cache when grading system changes
                    debouncedCalculate();
                }
            });

            document.getElementById('view-sgpa-info-btn').addEventListener('click', () => {
                document.getElementById('sgpa-info-modal').classList.remove('hidden');
            });
            
            document.getElementById('view-trends-btn').addEventListener('click', () => {
                const data = allSemesters.map(sem => ({
                    name: sem.name,
                    sgpa: calculateSemesterSGPA(sem)
                })).filter(d => d.sgpa > 0);

                const container = d3.select("#trends-chart-container");
                container.html("");
                d3.selectAll(".chart-tooltip").remove();

                if (data.length === 0) {
                    container.html('<p class="text-center text-gray-400">No semester data to display. Complete a course to see trends.</p>');
                    document.getElementById('trends-modal').classList.remove('hidden');
                    return;
                }
                
                const margin = {top: 20, right: 30, bottom: 40, left: 40};
                const width = 550 - margin.left - margin.right;
                const height = 300 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                const x = d3.scaleBand()
                  .range([ 0, width ])
                  .domain(data.map(d => d.name))
                  .padding(0.4);
                svg.append("g")
                  .attr("transform", `translate(0, ${height})`)
                  .call(d3.axisBottom(x))
                  .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("fill", "#9ca3af");

                const y = d3.scaleLinear()
                  .domain([0, 10])
                  .range([ height, 0]);
                svg.append("g")
                  .call(d3.axisLeft(y))
                  .selectAll("text")
                   .attr("fill", "#9ca3af");

                const tooltip = d3.select("body").append("div")
                    .attr("class", "chart-tooltip");

                svg.selectAll("mybar")
                  .data(data)
                  .join("rect")
                    .attr("x", d => x(d.name))
                    .attr("y", d => y(d.sgpa))
                    .attr("width", x.bandwidth())
                    .attr("height", d => height - y(d.sgpa))
                    .attr("fill", "#4f46e5")
                    .on("mouseover", (event, d) => {
                        tooltip.style("opacity", 1);
                        d3.select(event.currentTarget).style("fill", "#6366f1");
                    })
                    .on("mousemove", (event, d) => {
                        tooltip
                            .html(`<strong>${d.name}</strong><br>SGPA: ${d.sgpa.toFixed(2)}`)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseleave", (event, d) => {
                        tooltip.style("opacity", 0);
                        d3.select(event.currentTarget).style("fill", "#4f46e5");
                    });

                document.getElementById('trends-modal').classList.remove('hidden');
            });

            // --- Initial Load ---
            loadData();
            targetSgpaInput.value = appState.targetSgpa || '';
            fullRender();
        });
    </script>
</body>
</html>
